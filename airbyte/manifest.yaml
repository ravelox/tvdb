version: "0.30.0"
type: DeclarativeSource

spec:
  type: Spec
  connection_specification:
    $schema: http://json-schema.org/draft-07/schema#
    title: TVDB Source Spec
    type: object
    required:
      - api_url
    properties:
      api_url:
        type: string
        description: Base URL of the TVDB API (for example, https://tvdb.internal/api).
      api_token:
        type: string
        title: API Token
        description: Optional API token that will be sent via the x-api-token header.
        airbyte_secret: true

check:
  type: CheckStream
  stream_names:
    - shows

definitions:
  base_requester:
    type: HttpRequester
    url_base: "{{ config['api_url'].rstrip('/') }}"
    authenticator:
      type: ApiKeyAuthenticator
      header: x-api-token
      api_token: "{{ config.get('api_token', '') }}"
    error_handler:
      type: CompositeErrorHandler
      error_handlers:
        - type: DefaultErrorHandler
          max_retries: 3
        - type: RateLimitErrorHandler
          response_filter:
            type: HttpResponseFilter
            http_codes:
              - 429
          backoff_strategies:
            - type: WaitTimeFromHeader
              header: Retry-After
            - type: WaitFixed
              wait_time: 5

  default_paginator:
    type: DefaultPaginator
    page_size_option:
      type: RequestOption
      field_name: limit
      inject_into: request_parameter
    page_token_option:
      type: RequestOption
      field_name: offset
      inject_into: request_parameter
    pagination_strategy:
      type: OffsetIncrement
      page_size: 200

  streams:
    actors:
      type: DeclarativeStream
      name: actors
      primary_key: id
      retriever:
        type: SimpleRetriever
        requester:
          $ref: "#/definitions/base_requester"
          path: /actors
          http_method: GET
        paginator:
          $ref: "#/definitions/default_paginator"
        record_selector:
          type: RecordSelector
          extractor:
            type: DpathExtractor
            field_path: []
      schema_loader:
        type: InlineSchemaLoader
        schema:
          $schema: http://json-schema.org/draft-07/schema#
          type: object
          properties:
            id:
              type: integer
            name:
              type: string
            created_at:
              type:
                - string
                - "null"
              format: date-time

    shows:
      type: DeclarativeStream
      name: shows
      primary_key: id
      retriever:
        type: SimpleRetriever
        requester:
          $ref: "#/definitions/base_requester"
          path: /shows
          http_method: GET
        paginator:
          $ref: "#/definitions/default_paginator"
        record_selector:
          type: RecordSelector
          extractor:
            type: DpathExtractor
            field_path: []
      schema_loader:
        type: InlineSchemaLoader
        schema:
          $schema: http://json-schema.org/draft-07/schema#
          type: object
          properties:
            id:
              type: integer
            title:
              type: string
            description:
              type:
                - string
                - "null"
            year:
              type:
                - integer
                - "null"

    seasons:
      type: DeclarativeStream
      name: seasons
      primary_key: id
      retriever:
        type: SimpleRetriever
        requester:
          $ref: "#/definitions/base_requester"
          path: /shows/{{ stream_slice.show_id }}/seasons
          http_method: GET
        paginator:
          $ref: "#/definitions/default_paginator"
        record_selector:
          type: RecordSelector
          extractor:
            type: DpathExtractor
            field_path: []
      partition_router:
        - type: SubstreamPartitionRouter
          parent_stream_configs:
            - type: ParentStreamConfig
              stream:
                $ref: "#/definitions/streams/shows"
              parent_key: id
              partition_field: show_id
      schema_loader:
        type: InlineSchemaLoader
        schema:
          $schema: http://json-schema.org/draft-07/schema#
          type: object
          properties:
            id:
              type: integer
            show_id:
              type: integer
            season_number:
              type: integer
            year:
              type:
                - integer
                - "null"
            created_at:
              type:
                - string
                - "null"
              format: date-time

    episodes:
      type: DeclarativeStream
      name: episodes
      primary_key: id
      retriever:
        type: SimpleRetriever
        requester:
          $ref: "#/definitions/base_requester"
          path: /shows/{{ stream_slice.show_id }}/episodes
          http_method: GET
        paginator:
          $ref: "#/definitions/default_paginator"
        record_selector:
          type: RecordSelector
          extractor:
            type: DpathExtractor
            field_path: []
      partition_router:
        - type: SubstreamPartitionRouter
          parent_stream_configs:
            - type: ParentStreamConfig
              stream:
                $ref: "#/definitions/streams/shows"
              parent_key: id
              partition_field: show_id
      schema_loader:
        type: InlineSchemaLoader
        schema:
          $schema: http://json-schema.org/draft-07/schema#
          type: object
          properties:
            id:
              type: integer
            show_id:
              type: integer
            season_id:
              type: integer
            season_number:
              type:
                - integer
                - "null"
            title:
              type: string
            description:
              type:
                - string
                - "null"
            air_date:
              type:
                - string
                - "null"
              format: date

    characters:
      type: DeclarativeStream
      name: characters
      primary_key: id
      retriever:
        type: SimpleRetriever
        requester:
          $ref: "#/definitions/base_requester"
          path: /shows/{{ stream_slice.show_id }}/characters
          http_method: GET
        paginator:
          $ref: "#/definitions/default_paginator"
        record_selector:
          type: RecordSelector
          extractor:
            type: DpathExtractor
            field_path: []
      partition_router:
        - type: SubstreamPartitionRouter
          parent_stream_configs:
            - type: ParentStreamConfig
              stream:
                $ref: "#/definitions/streams/shows"
              parent_key: id
              partition_field: show_id
      schema_loader:
        type: InlineSchemaLoader
        schema:
          $schema: http://json-schema.org/draft-07/schema#
          type: object
          properties:
            id:
              type: integer
            show_id:
              type: integer
            name:
              type: string
            actor_id:
              type:
                - integer
                - "null"
            actor_name:
              type:
                - string
                - "null"

streams:
  - $ref: "#/definitions/streams/actors"
  - $ref: "#/definitions/streams/shows"
  - $ref: "#/definitions/streams/seasons"
  - $ref: "#/definitions/streams/episodes"
  - $ref: "#/definitions/streams/characters"
