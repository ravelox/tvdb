version: "0.1.0"
type: DeclarativeSource

check:
  type: CheckStream
  stream_names:
    - shows

spec:
  type: Spec
  connection_specification:
    $schema: http://json-schema.org/draft-07/schema#
    title: TVDB Source Spec
    type: object
    required:
      - api_url
    properties:
      api_url:
        type: string
        description: Base URL of the TVDB API.

definitions:
  base_requester:
    type: HttpRequester
    url_base: "{{ config['api_url'] }}"
  streams:
    actors:
      type: DeclarativeStream
      name: actors
      primary_key: id
      retriever:
        type: SimpleRetriever
        requester:
          $ref: "#/definitions/base_requester"
          path: /actors
          http_method: GET
        record_selector:
          type: RecordSelector
          extractor:
            type: DpathExtractor
            field_path: []
      schema_loader:
        type: InlineSchemaLoader
        schema:
          $schema: http://json-schema.org/draft-07/schema#
          type: object
          properties:
            id:
              type: integer
            name:
              type: string
    shows:
      type: DeclarativeStream
      name: shows
      primary_key: id
      retriever:
        type: SimpleRetriever
        requester:
          $ref: "#/definitions/base_requester"
          path: /shows
          http_method: GET
        record_selector:
          type: RecordSelector
          extractor:
            type: DpathExtractor
            field_path: []
      schema_loader:
        type: InlineSchemaLoader
        schema:
          $schema: http://json-schema.org/draft-07/schema#
          type: object
          properties:
            id:
              type: integer
            title:
              type: string
            description:
              type: string
            year:
              type: [integer, "null"]
    seasons:
      type: DeclarativeStream
      name: seasons
      primary_key: id
      retriever:
        type: SimpleRetriever
        requester:
          $ref: "#/definitions/base_requester"
          path: /shows/{{ stream_slice.show_id }}/seasons
          http_method: GET
        record_selector:
          type: RecordSelector
          extractor:
            type: DpathExtractor
            field_path: []
      partition_router:
        - type: SubstreamPartitionRouter
          parent_stream_configs:
            - type: ParentStreamConfig
              stream:
                $ref: "#/definitions/streams/shows"
              parent_key: id
              partition_field: show_id
      schema_loader:
        type: InlineSchemaLoader
        schema:
          $schema: http://json-schema.org/draft-07/schema#
          type: object
          properties:
            id:
              type: integer
            show_id:
              type: integer
            season_number:
              type: integer
            year:
              type: [integer, "null"]
    episodes:
      type: DeclarativeStream
      name: episodes
      primary_key: id
      retriever:
        type: SimpleRetriever
        requester:
          $ref: "#/definitions/base_requester"
          path: /shows/{{ stream_slice.show_id }}/episodes
          http_method: GET
        record_selector:
          type: RecordSelector
          extractor:
            type: DpathExtractor
            field_path: []
      partition_router:
        - type: SubstreamPartitionRouter
          parent_stream_configs:
            - type: ParentStreamConfig
              stream:
                $ref: "#/definitions/streams/shows"
              parent_key: id
              partition_field: show_id
      schema_loader:
        type: InlineSchemaLoader
        schema:
          $schema: http://json-schema.org/draft-07/schema#
          type: object
          properties:
            id:
              type: integer
            show_id:
              type: integer
            season_id:
              type: integer
            title:
              type: string
            description:
              type: [string, "null"]
            air_date:
              type: [string, "null"]
              format: date
    characters:
      type: DeclarativeStream
      name: characters
      primary_key: id
      retriever:
        type: SimpleRetriever
        requester:
          $ref: "#/definitions/base_requester"
          path: /shows/{{ stream_slice.show_id }}/characters
          http_method: GET
        record_selector:
          type: RecordSelector
          extractor:
            type: DpathExtractor
            field_path: []
      partition_router:
        - type: SubstreamPartitionRouter
          parent_stream_configs:
            - type: ParentStreamConfig
              stream:
                $ref: "#/definitions/streams/shows"
              parent_key: id
              partition_field: show_id
      schema_loader:
        type: InlineSchemaLoader
        schema:
          $schema: http://json-schema.org/draft-07/schema#
          type: object
          properties:
            id:
              type: integer
            show_id:
              type: integer
            name:
              type: string
            actor_id:
              type: [integer, "null"]

streams:
  - $ref: "#/definitions/streams/actors"
  - $ref: "#/definitions/streams/shows"
  - $ref: "#/definitions/streams/seasons"
  - $ref: "#/definitions/streams/episodes"
  - $ref: "#/definitions/streams/characters"
